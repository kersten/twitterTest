<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Twitter Map</title>

    <style type="text/css">
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Verdana;
            font-size: 10px;
        }

        #map_canvas {
            height: 100%;
        }

        @media print {
            html, body {
                height: auto;
            }

            #map_canvas {
                height: 650px;
            }
        }
    </style>

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script type="text/javascript">
        String.prototype.parseURL = function() {
            return this.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&~\?\/.=]+/g, function(url) {
                return url.link(url);
            });
        };

        var socket = io.connect(location.origin, {'connect timeout': 5000, 'max reconnection attempts': 500});

        $(document).ready(function () {
            var myOptions = {
                zoom: 4,
                center: new google.maps.LatLng(0, 0),
                disableDefaultUI: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                scrollwheel: false,
                disableDoubleClickZoom: true
            };

            var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

            var markers = [];
            var i = 0;

            socket.on('tweet', function (data) {
                var pos = new google.maps.LatLng(data.geo.coordinates[0], data.geo.coordinates[1]);

                marker = new google.maps.Marker({
                    map: map,
                    draggable: false,
                    animation: google.maps.Animation.DROP,
                    position: pos
                });

                console.log(data);

                data.text = data.text.parseURL().replace(/(^|\s)@(\w+)/g, '$1<a href="http://www.twitter.com/$2">@$2</a>').replace(/(^|\s)#(\w+)/g, '$1<a href="http://search.twitter.com/search?q=%23$2">#$2</a>');

                var infowindow = new google.maps.InfoWindow({
                    content: data.text,
                    zIndex: i + 10,
                    maxWidth: 150
                });

                infowindow.open(map, marker);

                markers.push({marker: marker, info: infowindow});

                if (markers.length > 2) {
                    markers[i].info.close();

                    var x = i;

                    google.maps.event.addListener(markers[x].marker, 'click', function () {
                        console.log(arguments);
                        markers[x].info.open(map, markers[x].info.marker);
                    });

                    i++;
                    //markers.shift();
                }
            });
        });
    </script>
</head>
<body>
    <div id="map_canvas" style="position: relative; background-color: rgb(229, 227, 223); overflow-x: hidden; overflow-y: hidden;">map div</div>
</body>
</html>